From ed874703ad553338f973d537b8159d0eb4375cc4 Mon Sep 17 00:00:00 2001
From: Luis Diaz Mas <piponazo@gmail.com>
Date: Fri, 25 May 2018 22:03:26 +0200
Subject: [PATCH] Prevent call to memcpy with size==0

(cherry picked from commit ed874703ad553338f973d537b8159d0eb4375cc4)
---
 src/preview.cpp | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- exiv2-stretch.git.orig/src/preview.cpp
+++ exiv2-stretch.git/src/preview.cpp
@@ -810,7 +810,7 @@
                     for (int i = 0; i < sizes.count(); i++) {
                         uint32_t offset = dataValue.toLong(i);
                         uint32_t size = sizes.toLong(i);
-                        if (offset + size <= static_cast<uint32_t>(io.size()))
+                        if (size!=0 && offset + size <= static_cast<uint32_t>(io.size()))
                             memcpy(pos, base + offset, size);
                         pos += size;
                     }
---

From 863aaebc92ff0b0ee3d302b7b5291002c043bc7b Mon Sep 17 00:00:00 2001
From: Luis Diaz Mas <piponazo@gmail.com>
Date: Fri, 25 May 2018 22:16:25 +0200
Subject: [PATCH] Use index to access buf.pData_

(cherry picked from commit 863aaebc92ff0b0ee3d302b7b5291002c043bc7b)
---
 src/preview.cpp | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

--- exiv2-stretch.git.orig/src/preview.cpp
+++ exiv2-stretch.git/src/preview.cpp
@@ -806,13 +806,13 @@
                 else {
                     // FIXME: the buffer is probably copied twice, it should be optimized
                     DataBuf buf(size_);
-                    Exiv2::byte* pos = buf.pData_;
+                    uint32_t idxBuf = 0;
                     for (int i = 0; i < sizes.count(); i++) {
                         uint32_t offset = dataValue.toLong(i);
                         uint32_t size = sizes.toLong(i);
                         if (size!=0 && offset + size <= static_cast<uint32_t>(io.size()))
-                            memcpy(pos, base + offset, size);
-                        pos += size;
+                            memcpy(&buf.pData_[idxBuf], base + offset, size);
+                        idxBuf += size;
                     }
                     dataValue.setDataArea(buf.pData_, buf.size_);
                 }
---

From 67a5a741153c876a6f1c189abb874721d1725c48 Mon Sep 17 00:00:00 2001
From: Luis Diaz Mas <piponazo@gmail.com>
Date: Fri, 25 May 2018 22:20:03 +0200
Subject: [PATCH] Throw when trying to write out of the buffer

(cherry picked from commit 67a5a741153c876a6f1c189abb874721d1725c48)
---
 src/preview.cpp | 2 ++
 1 file changed, 2 insertions(+)

--- exiv2-stretch.git.orig/src/preview.cpp
+++ exiv2-stretch.git/src/preview.cpp
@@ -810,6 +810,8 @@
                     for (int i = 0; i < sizes.count(); i++) {
                         uint32_t offset = dataValue.toLong(i);
                         uint32_t size = sizes.toLong(i);
+                        if (idxBuf + size >= size_)
+                            throw Error(58);
                         if (size!=0 && offset + size <= static_cast<uint32_t>(io.size()))
                             memcpy(&buf.pData_[idxBuf], base + offset, size);
                         idxBuf += size;
